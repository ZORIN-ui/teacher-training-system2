{% extends "base.html" %}

{% block title %}Server Error - Teacher Training System{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="text-center">
                <!-- Error Illustration -->
                <div class="error-illustration mb-4">
                    <i class="fas fa-exclamation-triangle fa-5x text-warning mb-3"></i>
                    <h1 class="display-1 text-danger fw-bold">500</h1>
                </div>
                
                <!-- Error Message -->
                <div class="error-content">
                    <h2 class="h4 mb-3">Internal Server Error</h2>
                    <p class="text-muted mb-4">
                        Something went wrong on our end. We're working to fix this issue. 
                        Please try again in a few moments.
                    </p>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
                        <button type="button" class="btn btn-primary" onclick="retryPage()">
                            <i class="fas fa-redo me-2"></i>Try Again
                        </button>
                        
                        <a href="{{ url_for('dashboard') if current_user.is_authenticated else url_for('index') }}" 
                           class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>
                            {% if current_user.is_authenticated %}
                                Go to Dashboard
                            {% else %}
                                Go to Home
                            {% endif %}
                        </a>
                    </div>
                </div>
                
                <!-- Error Details (for admins) -->
                {% if current_user.is_authenticated and current_user.role == 'admin' %}
                <div class="mt-5">
                    <div class="card bg-light border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-tools me-2"></i>Admin Information
                            </h6>
                        </div>
                        <div class="card-body text-start">
                            <p class="small mb-2"><strong>Error ID:</strong> {{ request.environ.get('REQUEST_ID', 'N/A') }}</p>
                            <p class="small mb-2"><strong>Timestamp:</strong> {{ moment().format('YYYY-MM-DD HH:mm:ss') }}</p>
                            <p class="small mb-2"><strong>User:</strong> {{ current_user.email if current_user.is_authenticated else 'Anonymous' }}</p>
                            <p class="small mb-0"><strong>Path:</strong> {{ request.path }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Helpful Actions -->
                <div class="mt-5">
                    <h6 class="text-muted mb-3">What can you do?</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x text-info mb-2"></i>
                                    <h6 class="card-title">Wait a moment</h6>
                                    <p class="card-text small text-muted">
                                        The issue might be temporary. Try refreshing the page in a few minutes.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-envelope fa-2x text-primary mb-2"></i>
                                    <h6 class="card-title">Contact Support</h6>
                                    <p class="card-text small text-muted">
                                        If the problem persists, please contact our support team.
                                    </p>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="contactSupport()">
                                        Contact Us
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body text-center">
                                    <i class="fas fa-arrow-left fa-2x text-success mb-2"></i>
                                    <h6 class="card-title">Go Back</h6>
                                    <p class="card-text small text-muted">
                                        Return to the previous page or go to the homepage.
                                    </p>
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="goBack()">
                                        Go Back
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Updates -->
                <div class="mt-4">
                    <div class="card bg-info bg-opacity-10 border-info">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle text-info me-3"></i>
                                <div class="text-start">
                                    <h6 class="mb-1">System Status</h6>
                                    <p class="mb-0 small text-muted">
                                        Our technical team has been notified and is working to resolve this issue.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function retryPage() {
    showSpinner();
    setTimeout(function() {
        location.reload();
    }, 1000);
}

function goBack() {
    if (window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = "{{ url_for('dashboard') if current_user.is_authenticated else url_for('index') }}";
    }
}

function contactSupport() {
    // Create a simple contact form or redirect to support
    const subject = encodeURIComponent('Server Error Report - Error 500');
    const body = encodeURIComponent(`
Hello Support Team,

I encountered a server error (500) while using the Teacher Training System.

Details:
- Page: ${window.location.href}
- Time: ${new Date().toISOString()}
- User: {{ current_user.email if current_user.is_authenticated else 'Anonymous' }}

Please investigate this issue.

Thank you.
    `);
    
    // Try to open email client
    const mailtoLink = `mailto:support@teachertraining.com?subject=${subject}&body=${body}`;
    
    try {
        window.location.href = mailtoLink;
    } catch (e) {
        // Fallback: show a modal or notification
        showNotification('Please contact support at: support@teachertraining.com', 'info');
    }
}

// Auto-retry mechanism (optional)
let retryCount = 0;
const maxRetries = 3;

function autoRetry() {
    if (retryCount < maxRetries) {
        retryCount++;
        console.log(`Auto-retry attempt ${retryCount}/${maxRetries}`);
        
        setTimeout(function() {
            fetch(window.location.href, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else if (retryCount < maxRetries) {
                        autoRetry();
                    }
                })
                .catch(() => {
                    if (retryCount < maxRetries) {
                        autoRetry();
                    }
                });
        }, 5000 * retryCount); // Exponential backoff
    }
}

// Start auto-retry after 10 seconds
setTimeout(autoRetry, 10000);

// Add animations
$(document).ready(function() {
    $('.error-illustration').addClass('fade-in');
    $('.error-content').addClass('slide-in-left');
    
    setTimeout(function() {
        $('.mt-5, .mt-4').addClass('fade-in');
    }, 500);
    
    // Add pulse animation to retry button
    setInterval(function() {
        $('.btn-primary').addClass('pulse');
        setTimeout(function() {
            $('.btn-primary').removeClass('pulse');
        }, 1000);
    }, 5000);
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.error-illustration {
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.pulse {
    animation: pulse 1s ease-in-out;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.display-1 {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.error-illustration .fa-exclamation-triangle {
    animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
    from { text-shadow: 0 0 5px #ffc107, 0 0 10px #ffc107, 0 0 15px #ffc107; }
    to { text-shadow: 0 0 10px #ffc107, 0 0 20px #ffc107, 0 0 30px #ffc107; }
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .display-1 {
        font-size: 4rem;
    }
    
    .error-illustration i {
        font-size: 3rem !important;
    }
}

/* Animation classes */
.fade-in {
    animation: fadeIn 0.8s ease-in;
}

.slide-in-left {
    animation: slideInLeft 0.8s ease-out;
}

@keyframes fadeIn {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes slideInLeft {
    from { 
        opacity: 0; 
        transform: translateX(-30px); 
    }
    to { 
        opacity: 1; 
        transform: translateX(0); 
    }
}

/* Status indicator */
.bg-info.bg-opacity-10 {
    background-color: rgba(13, 202, 240, 0.1) !important;
}

/* Card hover effects */
.card-body i {
    transition: transform 0.3s ease;
}

.card:hover .card-body i {
    transform: scale(1.1);
}

/* Button enhancements */
.btn {
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

/* Loading state for retry button */
.btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Admin panel styling */
.card.border-warning {
    border-width: 2px !important;
}

.card-header.bg-warning {
    border-bottom: 1px solid rgba(0,0,0,0.125);
}
</style>
{% endblock %}
