{% extends "base_simple.html" %}

{% block title %}Pending Enrollments - Admin - Teacher Training System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 mb-0">
                    <i class="fas fa-clock me-2 text-warning"></i>
                    Pending Enrollment Requests
                </h1>
                <div class="d-flex gap-2">
                    {% if pending %}
                    <button type="button" class="btn btn-success" onclick="selectAll()">
                        <i class="fas fa-check-double me-1"></i>Select All
                    </button>
                    <button type="button" class="btn btn-primary" onclick="bulkApprove()" id="bulk-approve-btn" disabled>
                        <i class="fas fa-check me-1"></i>Approve Selected
                    </button>
                    {% endif %}
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    {% if pending %}
                        <form id="bulk-form" method="POST" action="{{ url_for('bulk_approve_enrollments') }}">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" id="select-all" class="form-check-input">
                                            </th>
                                            <th>Student</th>
                                            <th>Course</th>
                                            <th>Category</th>
                                            <th>Request Date</th>
                                            <th>Department</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for request in pending %}
                                        <tr>
                                            <td>
                                                <input type="checkbox" name="enrollment_ids" value="{{ request.id }}" 
                                                       class="form-check-input enrollment-checkbox">
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                         style="width: 40px; height: 40px;">
                                                        {{ request.student_name[0].upper() }}
                                                    </div>
                                                    <div>
                                                        <strong>{{ request.student_name }}</strong>
                                                        <br>
                                                        <small class="text-muted">{{ request.student_email }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <a href="{{ url_for('course_detail', course_id=request.course_id) }}" 
                                                   class="text-decoration-none">
                                                    <strong>{{ request.course_title }}</strong>
                                                </a>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ request.category }}</span>
                                            </td>
                                            <td>
                                                <small>{{ request.enrolled_at[:16] }}</small>
                                                <br>
                                                <small class="text-muted">
                                                    {% set days_ago = ((request.enrolled_at | length) > 0) %}
                                                    Requested recently
                                                </small>
                                            </td>
                                            <td>
                                                {% if request.department %}
                                                    <span class="badge bg-light text-dark">{{ request.department }}</span>
                                                {% else %}
                                                    <span class="text-muted">Not specified</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <form method="POST" action="{{ url_for('admin_approve_enrollment', enrollment_id=request.id) }}" 
                                                          style="display: inline;">
                                                        <button type="submit" class="btn btn-success" 
                                                                title="Approve Request"
                                                                onclick="return confirm('Approve this enrollment request?')">
                                                            <i class="fas fa-check"></i>
                                                        </button>
                                                    </form>
                                                    <form method="POST" action="{{ url_for('admin_reject_enrollment', enrollment_id=request.id) }}" 
                                                          style="display: inline;">
                                                        <button type="submit" class="btn btn-danger" 
                                                                title="Reject Request"
                                                                onclick="return confirm('Reject this enrollment request? The student will be notified.')">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </form>
                                                    <a href="{{ url_for('course_detail', course_id=request.course_id) }}" 
                                                       class="btn btn-outline-info" title="View Course">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </form>
                        
                        <div class="mt-3 p-3 bg-light rounded">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-info-circle text-info me-1"></i>Quick Actions</h6>
                                    <p class="small mb-0">
                                        • Select multiple requests and use "Approve Selected" for bulk approval<br>
                                        • Click individual approve/reject buttons for single requests<br>
                                        • View course details before making decisions
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-bar text-primary me-1"></i>Statistics</h6>
                                    <p class="small mb-0">
                                        <strong>{{ pending|length }}</strong> pending requests<br>
                                        Oldest request: {{ pending[0].enrolled_at[:10] if pending else 'N/A' }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-check-circle fa-4x text-success mb-4"></i>
                            <h4 class="text-muted mb-3">No Pending Requests</h4>
                            <p class="text-muted mb-4">All enrollment requests have been processed. Great job!</p>
                            <div class="d-flex justify-content-center gap-3">
                                <a href="{{ url_for('admin_enrollments') }}" class="btn btn-primary">
                                    <i class="fas fa-users me-2"></i>View All Enrollments
                                </a>
                                <a href="{{ url_for('admin_courses') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-book-open me-2"></i>Manage Courses
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function selectAll() {
    const selectAllCheckbox = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.enrollment-checkbox');
    
    selectAllCheckbox.checked = !selectAllCheckbox.checked;
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateBulkApproveButton();
}

function updateBulkApproveButton() {
    const checkedBoxes = document.querySelectorAll('.enrollment-checkbox:checked');
    const bulkApproveBtn = document.getElementById('bulk-approve-btn');
    
    if (checkedBoxes.length > 0) {
        bulkApproveBtn.disabled = false;
        bulkApproveBtn.innerHTML = `<i class="fas fa-check me-1"></i>Approve Selected (${checkedBoxes.length})`;
    } else {
        bulkApproveBtn.disabled = true;
        bulkApproveBtn.innerHTML = '<i class="fas fa-check me-1"></i>Approve Selected';
    }
}

function bulkApprove() {
    const checkedBoxes = document.querySelectorAll('.enrollment-checkbox:checked');
    if (checkedBoxes.length === 0) {
        alert('Please select at least one enrollment request to approve.');
        return;
    }
    
    if (confirm(`Approve ${checkedBoxes.length} enrollment request(s)?`)) {
        document.getElementById('bulk-form').submit();
    }
}

// Add event listeners to checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.enrollment-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkApproveButton);
    });
    
    // Update select all checkbox based on individual selections
    const selectAllCheckbox = document.getElementById('select-all');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.enrollment-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkApproveButton();
        });
    }
});
</script>
{% endblock %}
